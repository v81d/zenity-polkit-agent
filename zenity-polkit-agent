#!/usr/bin/env bash

if [ "$1" != "_CALLED_INTERNALLY" ]; then
  exec cmd-polkit-agent -s -c "$0 _CALLED_INTERNALLY"
fi

shift

while read -r msg; do
  action=$(echo "$msg" | jq -r '.action // ""')

  if [ "$action" = "request password" ]; then
    prompt=$(echo "$msg" | jq -r '.prompt // "Authentication Required"')
    message=$(echo "$msg" | jq -r '.message // "Authentication"')

    passwd=$(zenity --password --title="$message" --text="$prompt" 2>/dev/null)

    if [ -z "$passwd" ]; then
      echo '{"action":"cancel"}'
    else
      printf '{"action":"authenticate","password":"%s"}\n' "$passwd"
    fi
  fi
done
